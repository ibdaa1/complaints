<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</title>
<style>
:root{--accent:#2a5b2a;--muted:#666;--card:#fafafa;--red:#d32f2f;--green:#388e3c}
body{font-family:Arial,"Noto Naskh Arabic",sans-serif;direction:rtl;background:#fff;color:#222;padding:12px}
.container{max-width:1400px;margin:0 auto}
.header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.h1{color:var(--accent);margin:0}
.card{background:var(--card);padding:12px;border-radius:8px;border:1px solid #eee;margin-bottom:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.col{flex:1;min-width:160px}
label{display:block;font-weight:700;margin-top:6px;font-size:12px}
input,select,textarea,button{font-family:inherit}
input,select,textarea{width:100%;padding:6px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;font-size:12px}
textarea{min-height:50px}
button{background:var(--accent);color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px}
button.secondary{background:transparent;color:var(--accent);border:1px solid rgba(0,0,0,0.08)}
button.clear{background:#fff;color:var(--accent);border:1px solid #ddd}
button.home-btn{background:#1976d2;margin-left:8px}
button.new-btn{background:#388e3c}
.small{font-size:11px;color:var(--muted)}
.table-wrap{overflow:auto;margin-top:12px;max-height:600px}
table{width:100%;border-collapse:collapse;font-size:10px}
th,td{border:1px solid #ddd;padding:4px 6px;text-align:right;vertical-align:top;white-space:normal;word-wrap:break-word;line-height:1.3}
td{max-width:150px}
th{background:#f0f0f0;position:sticky;top:0;z-index:2;font-weight:700}
tbody tr:hover{background:#f9f9f9}
.filter-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
.filter-col{display:flex;flex-direction:column;gap:4px}
.display-name{display:inline-block;padding:4px 6px;background:#f9f9f9;border-radius:6px;border:1px solid #eee;font-size:12px}
.last-inspect{background:#fffbe6;border:1px solid #ffe58f;padding:8px;border-radius:6px;margin-top:8px}
.last-inspect table{font-size:11px;margin-top:8px}
.last-inspect th,.last-inspect td{padding:4px 8px}
.product-row{border:1px solid #eee;padding:8px;border-radius:6px;margin-bottom:8px;background:#fff}
.time-ok{color:var(--green);font-weight:700}
.time-exceeded{color:var(--red);font-weight:700}
.report-link{color:#1976d2;text-decoration:none;font-size:14px}
.report-link:hover{text-decoration:underline}
.nav-bar{display:flex;gap:8px;margin-bottom:12px;padding:8px;background:#f5f5f5;border-radius:8px}
@media(max-width:900px){.row{flex-direction:column}.filter-row{flex-direction:column}}
</style>
</head>
<body>
<div class="container">
  <!-- Navigation Bar -->
  <div class="nav-bar">
    <a href="/shjfcs/index.php"><button type="button" class="home-btn">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button></a>
    <button type="button" id="btnNewComplaint" class="new-btn">â• Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©</button>
  </div>

  <div class="header">
    <h1 class="h1">Ù†Ø¸Ø§Ù… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h1>
    <div class="small">Ø¹Ø±Ø¶ØŒ Ø¨Ø­Ø« ØªØ³Ø¬ÙŠÙ„ØŒ ÙØªØ­/ØªØ¹Ø¯ÙŠÙ„ØŒ ØªÙˆÙ‚ÙŠØ¹ØŒ Ù…Ù†ØªØ¬Ø§ØªØŒ Ø±ÙØ¹ Ù…Ø±ÙÙ‚Ø§Øª</div>
  </div>

  <!-- Top summary -->
  <div class="card">
    <div class="row" style="align-items:center">
      <div class="small">ØªØ­ØªØ§Ø¬ ØªÙˆÙ‚ÙŠØ¹ Ø³ÙˆØ¨Ø±ÙØ§ÙŠØ²Ø±: <strong id="countNeedSupervisor">0</strong></div>
      <div class="small" style="margin-right:16px">ØªØ­ØªØ§Ø¬ ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¯ÙŠØ±: <strong id="countNeedManager">0</strong></div>
      <div style="margin-right:auto">
        <button id="btnReload" class="secondary">ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ„</button>
      </div>
    </div>
  </div>

  <!-- License search -->
  <div class="card">
    <h4 style="margin:0 0 8px 0">Ø¨Ø­Ø« Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ)</h4>
    <div class="row">
      <div class="col"><input id="license_no_search" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ"></div>
      <div style="width:120px"><button id="btnSearchLicense" class="secondary">Ø¨Ø­Ø« ØªØ³Ø¬ÙŠÙ„</button></div>
      <div style="width:100px"><button id="btnClearLicense" class="clear">Ù…Ø³Ø­</button></div>
    </div>
    <div id="estList" class="small" style="margin-top:8px"></div>
    <div id="estDetails" class="small" style="margin-top:8px"></div>
  </div>

  <!-- Complaint form -->
  <div class="card" id="formCard">
    <h4 style="margin:0 0 8px 0">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø´ÙƒÙˆÙ‰ (ÙØªØ­ / ØªØ¹Ø¯ÙŠÙ„)</h4>
    <form id="complaintForm" onsubmit="return false;">
      <input type="hidden" id="id">

      <div class="row">
        <div class="col"><label>unique_id</label><input id="establishment_unique_id" readonly></div>
        <div class="col"><label>Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©</label><input id="license_no_display" readonly></div>
        <div class="col"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©</label><input id="facility_name" readonly></div>
      </div>

      <h4 style="margin:12px 0 8px 0">Ù‚Ø³Ù… Ø§Ù„Ù…ÙØªØ´</h4>
      <div class="row">
        <div class="col">
          <label>Ø§Ù„Ù…ÙØªØ´</label>
          <span id="inspector_display" class="display-name">-</span>
          <input type="hidden" id="created_by_empid">
        </div>
        <div class="col"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</label><input id="received_datetime" type="datetime-local"></div>
        <div class="col"><label>Ù…ØµØ¯Ø± Ø§Ù„Ø´ÙƒÙˆÙ‰</label><select id="complaints_source"></select></div>
      </div>

      <div class="row">
        <div class="col"><label>Ø§Ø³Ù… Ø§Ù„Ø´Ø§ÙƒÙŠ</label><input id="complainant_name"></div>
        <div class="col"><label>Ù‡Ø§ØªÙ Ø§Ù„Ø´Ø§ÙƒÙŠ</label><input id="complainant_phone"></div>
        <div class="col"><label>Ø±Ù‚Ù… Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø®Ø· Ø§Ù„Ø³Ø§Ø®Ù†</label><input id="hotline_complaint_number"></div>
      </div>

      <label>Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰</label><textarea id="complaint_subject"></textarea>
      <label>Ø¨ÙŠØ§Ù† Ø§Ù„Ø´Ø§ÙƒÙŠ</label><textarea id="complainant_statement"></textarea>
      <label>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ÙØªØ´</label><textarea id="inspector_followup"></textarea>
      <label>Ø¨ÙŠØ§Ù† Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹</label><textarea id="site_manager_statement"></textarea>

      <div class="row">
        <div class="col"><label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹ÙŠÙ†Ø©</label><select id="sample_status"></select></div>
        <div class="col"><label>Ø¥Ø¬Ø±Ø§Ø¡ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø´Ø§ÙƒÙŠ</label><select id="complainant_contact_action"></select></div>
        <div class="col"><label>Ø§Ø´ØªØ¨Ø§Ù‡ ØªØ³Ù…Ù… ØºØ°Ø§Ø¦ÙŠ</label><select id="food_poisoning_suspect"></select></div>
      </div>

      <div class="row">
        <div class="col"><label>ØªØ§Ø±ÙŠØ® Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙØªØ´</label><input id="inspector_received_datetime" type="datetime-local"></div>
      </div>

      <div class="row">
        <div class="col"><label>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø³Ù… (ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±)</label><select id="section_actions" class="manager-field"></select></div>
      </div>
      <label>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©</label><textarea id="taken_actions"></textarea>

      <!-- Time difference display -->
      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© (Ø§Ø³ØªÙ„Ø§Ù… â†’ Ù…ÙØªØ´)</label>
          <span id="response_time_display" class="display-name">-</span>
        </div>
        <div class="col">
          <label>ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ù…ÙØªØ´ â†’ Ø¥ØºÙ„Ø§Ù‚)</label>
          <span id="closure_time_display" class="display-name">-</span>
        </div>
      </div>

      <div id="lastInspection" class="last-inspect" style="display:none"></div>

      <h4 style="margin:12px 0 8px 0">Ù‚Ø³Ù… Ø§Ù„Ø³ÙˆØ¨Ø±ÙØ§ÙŠØ²Ø±</h4>
      <div class="row">
        <div class="col"><label>Ø§Ù„Ù…Ø´Ø±Ù</label><span id="sup_display" class="display-name">-</span><input type="hidden" id="supervisor_empid"></div>
        <div class="col"><label>ØªØµÙ†ÙŠÙ Ø§Ù„Ø´ÙƒÙˆÙ‰</label><select id="complaint_category" class="supervisor-field"></select></div>
        <div class="col"><label>Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©</label><input id="response_speed" readonly class="supervisor-field"></div>
      </div>
      <div class="row">
        <div class="col"><label>ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ø´Ø±Ù</label><textarea id="supervisor_comment" class="supervisor-field"></textarea></div>
        <div class="col"><label>ØªØ§Ø±ÙŠØ® Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù</label><input id="followup_datetime" type="datetime-local" readonly></div>
      </div>
      <div style="margin-top:8px">
        <button id="btnSaveSupervisor" class="secondary" type="button">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø³ÙˆØ¨Ø±ÙØ§ÙŠØ²Ø±</button>
        <button id="btnSupervisorClear" class="clear" type="button">Ø­Ø°Ù ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø³ÙˆØ¨Ø±ÙØ§ÙŠØ²Ø±</button>
      </div>

      <h4 style="margin:12px 0 8px 0">Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±</h4>
      <div class="row">
        <div class="col"><label>Ø§Ù„Ù…Ø¯ÙŠØ±</label><span id="mgr_display" class="display-name">-</span><input type="hidden" id="manager_empid"></div>
        <div class="col"><label>Ø­Ø§Ù„Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰ (Ø§Ù„Ù…Ø¯ÙŠØ±)</label><select id="complaint_status" class="manager-field"></select></div>
        <div class="col"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</label><input id="closed_datetime" type="datetime-local" readonly></div>
      </div>
      <div class="row">
        <div class="col"><label>ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ù…Ø¯ÙŠØ±</label><textarea id="division_head_comment" class="manager-field"></textarea></div>
      </div>
      <div style="margin-top:8px">
        <button id="btnSaveManager" class="secondary" type="button">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
        <button id="btnManagerClear" class="clear" type="button">Ø­Ø°Ù ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button id="btnSave" type="button">Ø­ÙØ¸ Ø§Ù„Ø´ÙƒÙˆÙ‰</button>
        <button id="btnReset" class="secondary" type="button">Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
        <span id="formMsg" class="small" style="margin-right:auto"></span>
      </div>
    </form>
  </div>

  <!-- Products section -->
  <div class="card">
    <h4 style="margin:0 0 8px 0">Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø´ÙƒÙˆÙ‰</h4>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <button id="btnAddProduct" type="button">Ø¥Ø¶Ø§ÙØ© ØµÙ Ù…Ù†ØªØ¬</button>
      <button id="btnSaveProducts" type="button" class="secondary">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¯ÙØ¹Ø©</button>
    </div>
    <div id="productsList"></div>
  </div>

  <!-- Attachments section -->
  <div class="card">
    <h4 style="margin:0 0 8px 0">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</h4>
    <div class="row">
      <div class="col"><label>Ø±ÙØ¹ Ù…Ø±ÙÙ‚</label><input type="file" id="attachment_file"></div>
      <div style="width:120px;display:flex;align-items:flex-end"><button id="btnUpload" type="button" class="secondary">Ø±ÙØ¹</button></div>
    </div>
    <input type="hidden" id="attachment_url">
    <div id="attachmentLink" class="small" style="margin-top:8px"></div>
  </div>

  <!-- Filters + table -->
  <div class="card">
    <h4 style="margin:0 0 8px 0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</h4>

    <div class="filter-row">
      <div class="filter-col" style="min-width:150px"><label>Ø¨Ø­Ø« Ø´Ø§Ù…Ù„</label><input id="searchAll" placeholder="Ø¨Ø­Ø«"></div>
      <div class="filter-col" style="width:120px"><label>Ù‡Ø§ØªÙ Ø§Ù„Ø´Ø§ÙƒÙŠ</label><input id="filter_phone" placeholder="Ù‡Ø§ØªÙ"></div>
      <div class="filter-col" style="width:140px"><label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label><select id="filter_area"><option value="">Ø§Ù„ÙƒÙ„</option></select></div>
      <div class="filter-col" style="width:140px"><label>Ø§Ù„Ù†Ø´Ø§Ø·</label><select id="filter_activity"><option value="">Ø§Ù„ÙƒÙ„</option></select></div>
      <div class="filter-col" style="width:120px"><label>Ø§Ù„ÙˆØ­Ø¯Ø©</label><select id="filter_unit"><option value="">Ø§Ù„ÙƒÙ„</option></select></div>
      <div class="filter-col" style="width:140px"><label>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©</label><select id="filter_hazard"><option value="">Ø§Ù„ÙƒÙ„</option></select></div>
      <div class="filter-col" style="width:140px"><label>Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙØ±Ø¹ÙŠ</label><select id="filter_sub_sector"><option value="">Ø§Ù„ÙƒÙ„</option></select></div>
      <div class="filter-col" style="width:120px"><label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input id="filter_date_from" type="date"></div>
      <div class="filter-col" style="width:120px"><label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input id="filter_date_to" type="date"></div>
      <div style="display:flex;gap:8px;align-items:flex-end"><button id="btnApplyFilters" class="secondary">ØªØ·Ø¨ÙŠÙ‚</button><button id="btnResetFilters" class="clear">Ù…Ø³Ø­</button></div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
      <span class="small">ØªØ¨Ø¯ÙŠÙ„ Ø³Ø±ÙŠØ¹:</span>
      <button id="btnNeedsSup" class="clear" data-on="0">ØªØ­ØªØ§Ø¬ ØªÙˆÙ‚ÙŠØ¹ Ø³ÙˆØ¨Ø±</button>
      <button id="btnNeedsMgr" class="clear" data-on="0">ØªØ­ØªØ§Ø¬ ØªÙˆÙ‚ÙŠØ¹ Ù…Ø¯ÙŠØ±</button>
      <button id="btnCompleted" class="clear" data-on="0">Ù…ÙƒØªÙ…Ù„Ø©</button>
      <button id="btnNeedsAny" class="clear" data-on="0">ØªØ­ØªØ§Ø¬ ØªÙˆÙ‚ÙŠØ¹Ø§Øª</button>
    </div>

    <div id="tableWrap" class="table-wrap"></div>
  </div>
</div>

<script>
(function(){
'use strict';

const $ = id => document.getElementById(id);
const pad = n => String(n).padStart(2,'0');

async function fetchJson(url, opts={}) {
  opts.credentials = 'same-origin';
  try {
    const r = await fetch(url, opts);
    const txt = await r.text();
    try { return JSON.parse(txt); } catch(e) { console.warn('Invalid JSON from', url); return null; }
  } catch(e) { console.warn('Fetch failed for', url, e); return null; }
}

let currentUser = { EmpID:null, EmpName:'', permissions:{} };
let employees = {};
let complaints = [];
let establishments = {};
let lastInspections = {};

// Lists matching complaintData.js
const complaintSources = ["Ø§Ù„Ø®Ø· Ø§Ù„Ø³Ø§Ø®Ù†","Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„","Ø´Ø®ØµÙŠØ§Ù‹ Ø¨Ø§Ù„Ù…ÙƒØªØ¨","Ø§Ù„Ø§Ø¯Ø§Ø±Ø©","Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©","ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‡Ø§ØªÙ"];
const sampleStatusOptions = ["Ù…ÙˆØ¬ÙˆØ¯Ø©","ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©","ØªÙ… Ø§Ø±Ø³Ø§Ù„ ØµÙˆØ±Ù‡Ø§ Ø¨Ø§Ù„Ù‡Ø§ØªÙ","ØªÙ… Ø§ØªÙ„Ø§ÙÙ‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø´Ø§ÙƒÙ‰","ØªÙ… Ø§Ø±Ø¬Ø§Ø¹Ù‡Ø§ Ù„Ù„Ù…ÙˆÙ‚Ø¹","ØªÙ… Ø§Ø­Ø¶Ø§Ø± Ø§Ù„Ø¹ÙŠÙ†Ø© Ù„Ù„Ù‚Ø³Ù…","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹ÙŠÙ†Ø© Ù„Ù„Ø´ÙƒÙˆÙ‰"];
const complainantContactActions = ["ØªÙ… Ù…Ù‚Ø§Ø¨Ù„Ø© Ø§Ù„Ø´Ø§ÙƒÙ‰ ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹ÙŠÙ†Ø©","ØªÙ… Ù…Ù‚Ø§Ø¨Ù„Ø© Ø§Ù„Ø´Ø§ÙƒÙ‰ ÙˆÙ„Ù… ÙŠØ­Ø¶Ø± Ø§Ù„Ø¹ÙŠÙ†Ø©","ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø§ÙƒÙ‰ ÙˆÙ„Ù… ÙŠØ­Ø¶Ø± Ø§Ù„Ø¹ÙŠÙ†Ø©","ØªÙ… Ø§Ø±Ø³Ø§Ù„ ØµÙˆØ± Ø§Ù„Ø¹ÙŠÙ†Ø© Ø¹Ø¨Ø± ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„","ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø§ÙƒÙ‰ ÙˆØ§Ø®Ø° Ø§ÙØ§Ø¯ØªÙ‡","ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø§ÙƒÙ‰ ÙˆÙ„Ù… ÙŠØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ","ØªÙ… Ù…Ù‚Ø§Ø¨Ù„Ø© Ø§Ù„Ø´Ø§ÙƒÙ‰ ÙˆØ§Ø®Ø° Ø§ÙØ§Ø¯ØªÙ‡ Ø´ÙÙ‡ÙŠØ§Ù‹"];
// Ø­Ø§Ù„Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰ - Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø´ØªÙ‚Ø©
const complaintStatusOptions = ["","Ø§Ù„Ø´ÙƒÙˆÙ‰ ØºÙŠØ± ØµØ­ÙŠØ­Ø©","Ø§Ù„Ø´ÙƒÙˆÙ‰ ØµØ­ÙŠØ­Ø©","Ø§Ù„Ø´ÙƒÙˆÙ‰ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡","ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ù‰ Ø¬Ù‡Ø© Ø§Ù„Ø§Ø®ØªØµØ§Øµ"];
const complaintCategories = ["","Ø§Ù„Ù†Ø¸Ø§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ø©","Ø§Ù„Ù…Ø¨Ø§Ù†Ù‰ ÙˆØ§Ù„Ù…Ù†Ø´Ø§Øª","Ø·Ø±Ù‚ Ø§Ø¹Ø¯Ø§Ø¯ ÙˆØ­ÙØ¸","Ø§Ù„ØºØ´ Ø§Ù„ØªØ¬Ø§Ø±Ù‰","Ø§Ù„Ø­Ø´Ø±Ø§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ø±Ø¶","Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©","Ù…Ø®Ø§Ù„ÙØ§Øª Ø³ÙˆÙ‚ Ø§Ù„Ø®Ø¶Ø§Ø± ÙˆØ§Ù„Ø³Ù…Ùƒ","Ù…Ø®Ø§Ù„ÙØ§Øª Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ·Ø±Ø©","Ø§Ø´ØªØ¨Ø§Ø© ØªØ³Ù…Ù… ØºØ°Ø§Ø¦Ù‰","Ø´ÙƒÙˆÙ‰ ØªØ­ØªØ§Ø¬ Ø§Ù„Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¹ Ø¬Ù‡Ø§Øª Ø§Ø®Ø±Ù‰","Ø§Ø´ØªØ¨Ø§Ø© ØªØ³Ù…Ù… ØºØ°Ø§Ø¦Ù‰ Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ± Ù…Ø³ØªØ´ÙÙ‰","Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ø­ØªØ±Ø§Ø²ÙŠØ©"];
const foodPoisoningSuspects = ["","Ø¯Ø§Ø®Ù„ Ø§Ù„Ø§Ù…Ø§Ø±Ø©","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø§Ù…Ø§Ø±Ø©","Ù…Ù†Ø²Ù„Ù‰","Ù„Ø§ ÙŠÙˆØ¬Ø¯"];
// Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø³Ù… - ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†
const sectionActionsOptions = ["","Ø­ÙØ¸","Ù…Ø®Ø§Ù„ÙØ©","ØªØ­ÙØ¸","Ø§Ø®Ø° Ø¹ÙŠÙ†Ø©","Ø§Ù†Ø°Ø§Ø±","Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø§Ù„Ù…ÙØªØ´","Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‰ Ø¬Ù‡Ø© Ø§Ù„Ø§Ø®ØªØµØ§Øµ"];

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø³Ù…
function derivedComplaintStatus(sectionAction) {
  if (!sectionAction) return '';
  switch(sectionAction) {
    case "Ø­ÙØ¸":
      return "Ø§Ù„Ø´ÙƒÙˆÙ‰ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    case "Ù…Ø®Ø§Ù„ÙØ©":
      return "Ø§Ù„Ø´ÙƒÙˆÙ‰ ØµØ­ÙŠØ­Ø©";
    case "ØªØ­ÙØ¸":
    case "Ø§Ø®Ø° Ø¹ÙŠÙ†Ø©":
    case "Ø§Ù†Ø°Ø§Ø±":
    case "Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ø§Ù„Ù…ÙØªØ´":
      return "Ø§Ù„Ø´ÙƒÙˆÙ‰ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡";
    case "Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‰ Ø¬Ù‡Ø© Ø§Ù„Ø§Ø®ØªØµØ§Øµ":
      return "ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ù‰ Ø¬Ù‡Ø© Ø§Ù„Ø§Ø®ØªØµØ§Øµ";
    default:
      return '';
  }
}

// Calculate response speed based on category (from complaintData.js)
function complaintUrgency(category) {
  if (!category) return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
  switch(category) {
    case "Ø§Ù„Ù†Ø¸Ø§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ø©":
    case "Ø·Ø±Ù‚ Ø§Ø¹Ø¯Ø§Ø¯ ÙˆØ­ÙØ¸":
    case "Ø§Ù„ØºØ´ Ø§Ù„ØªØ¬Ø§Ø±Ù‰":
    case "Ø§Ù„Ø­Ø´Ø±Ø§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ø±Ø¶":
    case "Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©":
    case "Ù…Ø®Ø§Ù„ÙØ§Øª Ø³ÙˆÙ‚ Ø§Ù„Ø®Ø¶Ø§Ø± ÙˆØ§Ù„Ø³Ù…Ùƒ":
    case "Ù…Ø®Ø§Ù„ÙØ§Øª Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ·Ø±Ø©":
    case "Ø§Ø´ØªØ¨Ø§Ø© ØªØ³Ù…Ù… ØºØ°Ø§Ø¦Ù‰ Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ± Ù…Ø³ØªØ´ÙÙ‰":
      return "Ø¹Ø§Ø¬Ù„Ø© Ø®Ù„Ø§Ù„ ÙŠÙˆÙ… Ø¹Ù…Ù„ ÙˆØ§Ø­Ø¯";
    case "Ø§Ù„Ù…Ø¨Ø§Ù†Ù‰ ÙˆØ§Ù„Ù…Ù†Ø´Ø§Øª":
      return "Ø¹Ø§Ø¯ÙŠØ© Ø®Ù„Ø§Ù„ Ø®Ù…Ø³ Ø£ÙŠØ§Ù… Ø¹Ù…Ù„";
    case "Ø§Ø´ØªØ¨Ø§Ø© ØªØ³Ù…Ù… ØºØ°Ø§Ø¦Ù‰":
    case "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ø­ØªØ±Ø§Ø²ÙŠØ©":
      return "Ø·Ø§Ø±Ø¦Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙÙˆØ±ÙŠØ©";
    case "Ø´ÙƒÙˆÙ‰ ØªØ­ØªØ§Ø¬ Ø§Ù„Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø¹ Ø¬Ù‡Ø§Øª Ø§Ø®Ø±Ù‰":
      return "Ù…Ø¹Ù‚Ø¯Ø© Ø®Ù„Ø§Ù„ ÙØªØ±Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
    default:
      return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
  }
}

function toLocalDateTime(v){ if(!v) return ''; return String(v).replace(' ','T').slice(0,16); }
function toDBDateTimeFromLocal(v){ if(!v) return ''; const d = new Date(v); if(isNaN(d)) return ''; return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
function getName(empid){ if(!empid) return ''; return employees[String(empid)] || String(empid); }
function escapeHtml(s){ if(!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function populateSelect(id, items, includeEmpty=true, emptyText='--'){
  const el = $(id); if(!el) return;
  el.innerHTML = '';
  if(includeEmpty) el.appendChild(new Option(emptyText,''));
  items.forEach(i => el.appendChild(new Option(i,i)));
}

function formatDateInTimeZone(date = new Date(), timeZone = 'Asia/Dubai') {
  try {
    const fmt = new Intl.DateTimeFormat('en-GB', { timeZone, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
    const parts = fmt.formatToParts(date).reduce((a,p)=> (a[p.type]=p.value,a), {});
    return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}:${parts.second}`;
  } catch(e) {
    const d = new Date(date.toLocaleString('en-US', { timeZone }));
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
}

// Calculate time difference and return formatted string with status
function calcTimeDiff(startStr, endStr, limitHours) {
  if(!startStr || !endStr) return { text: '-', exceeded: false };
  const start = new Date(startStr.replace(' ','T'));
  const end = new Date(endStr.replace(' ','T'));
  if(isNaN(start) || isNaN(end)) return { text: '-', exceeded: false };
  const diffMs = end - start;
  if(diffMs < 0) return { text: '-', exceeded: false };
  const diffMins = Math.floor(diffMs / 60000);
  const hours = Math.floor(diffMins / 60);
  const mins = diffMins % 60;
  const exceeded = hours >= limitHours;
  const status = exceeded ? 'ØªØ®Ø·ÙŠ Ø§Ù„Ø­Ø¯ÙˆØ¯' : 'Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯';
  return { text: `${hours} Ø³Ø§Ø¹Ø© ${mins} Ø¯Ù‚ÙŠÙ‚Ø© (${status})`, exceeded };
}

async function loadUserAndEmployees(){
  const u = await fetchJson('user_data.php');
  if(u && u.success && u.user_data){
    currentUser = u.user_data;
    currentUser.permissions = u.permissions || {};
  }
  const em = await fetchJson('get_employees.php');
  if(em && em.success && Array.isArray(em.data)){
    employees = {};
    em.data.forEach(x => {
      const name = x.EmpName || x.full_name || x.name || x.displayName;
      employees[String(x.EmpID)] = name || String(x.EmpID);
    });
    if(currentUser && currentUser.EmpID && $('inspector_display')){
      $('inspector_display').textContent = employees[String(currentUser.EmpID)] || currentUser.EmpName || '-';
    }
  }
  // Apply permissions-based field enabling/disabling
  applyPermissions();
}

// Apply permission-based enabling/disabling of fields
function applyPermissions(){
  const perms = currentUser.permissions || {};
  const isAdmin = perms.isAdmin === true;
  const isSuperAdmin = perms.isSuperAdmin === true;
  
  // Supervisor fields (complaint_category, response_speed, supervisor_comment) - enabled for admin/super admin
  const canSignSupervisor = isAdmin || isSuperAdmin;
  document.querySelectorAll('.supervisor-field').forEach(el => {
    el.disabled = !canSignSupervisor;
  });
  if($('btnSaveSupervisor')) $('btnSaveSupervisor').disabled = !canSignSupervisor;
  if($('btnSupervisorClear')) $('btnSupervisorClear').disabled = !canSignSupervisor;
  
  // Manager fields (section_actions, complaint_status, division_head_comment) - enabled for super admin only
  const canSignManager = isSuperAdmin;
  document.querySelectorAll('.manager-field').forEach(el => {
    el.disabled = !canSignManager;
  });
  if($('btnSaveManager')) $('btnSaveManager').disabled = !canSignManager;
  if($('btnManagerClear')) $('btnManagerClear').disabled = !canSignManager;
}

async function loadComplaints(){
  const j = await fetchJson('complaints.php?action=list');
  if(j && j.success) complaints = j.data || []; else complaints = [];
  $('countNeedSupervisor').textContent = complaints.filter(c=>!c.supervisor_empid).length;
  $('countNeedManager').textContent = complaints.filter(c=>!c.manager_empid).length;
}

async function preloadEstablishments(){
  const uids = Array.from(new Set(complaints.map(c => c.establishment_unique_id).filter(Boolean)));
  await Promise.all(uids.map(async uid => {
    if(establishments[uid] !== undefined) return;
    const j = await fetchJson('get_establishment.php?unique_id=' + encodeURIComponent(uid));
    establishments[uid] = (j && j.success && j.data) ? j.data : {};
  }));
}

async function preloadLastInspections(){
  const uids = Array.from(new Set(complaints.map(c => c.establishment_unique_id).filter(Boolean)));
  await Promise.all(uids.map(async uid => {
    if(lastInspections[uid] !== undefined) return;
    const j = await fetchJson('get_inspections.php?facility_unique_id=' + encodeURIComponent(uid));
    if(j && j.success && Array.isArray(j.data) && j.data.length > 0){
      lastInspections[uid] = j.data; // Store all inspections
    } else {
      lastInspections[uid] = null;
    }
  }));
}

async function getEstablishment(uid){
  if(!uid) return null;
  if(establishments[uid] !== undefined) return establishments[uid];
  const j = await fetchJson('get_establishment.php?unique_id=' + encodeURIComponent(uid));
  establishments[uid] = (j && j.success && j.data) ? j.data : {};
  return establishments[uid];
}

async function fetchLastInspectionAndActions(uid){
  if(!uid) return null;
  if(lastInspections[uid] !== undefined) return lastInspections[uid];
  const j = await fetchJson('get_inspections.php?facility_unique_id=' + encodeURIComponent(uid));
  if(j && j.success && Array.isArray(j.data) && j.data.length > 0){
    lastInspections[uid] = j.data;
    return lastInspections[uid];
  }
  lastInspections[uid] = null;
  return null;
}

function populateFilters(){
  const areas = new Set();
  const activities = new Set();
  const units = new Set();
  const hazards = new Set();
  const subSectors = new Set();
  
  complaints.forEach(c => {
    const est = establishments[c.establishment_unique_id] || {};
    if(est.area) areas.add(est.area);
    if(est.activity_type) activities.add(est.activity_type);
    else if(est.detailed_activities) activities.add(est.detailed_activities);
    if(est.unit) units.add(est.unit);
    else if(est.Sub_UNIT) units.add(est.Sub_UNIT);
    if(est.hazard_class) hazards.add(est.hazard_class);
    if(est.Sub_Sector !== undefined && est.Sub_Sector !== null && est.Sub_Sector !== '') subSectors.add(String(est.Sub_Sector));
  });
  
  const areaEl = $('filter_area');
  areaEl.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
  Array.from(areas).sort().forEach(v => areaEl.appendChild(new Option(v,v)));
  
  const actEl = $('filter_activity');
  actEl.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
  Array.from(activities).sort().forEach(v => actEl.appendChild(new Option(v,v)));
  
  const unitEl = $('filter_unit');
  unitEl.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
  Array.from(units).sort().forEach(v => unitEl.appendChild(new Option(v,v)));
  
  const hazEl = $('filter_hazard');
  hazEl.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
  Array.from(hazards).sort().forEach(v => hazEl.appendChild(new Option(v,v)));
  
  const subSectorEl = $('filter_sub_sector');
  subSectorEl.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>';
  Array.from(subSectors).sort((a,b) => Number(a) - Number(b)).forEach(v => subSectorEl.appendChild(new Option(v,v)));
}

function renderTable(){
  const q = ($('searchAll').value || '').toLowerCase().trim();
  const phone = ($('filter_phone').value || '').trim();
  const filterArea = ($('filter_area').value || '').trim();
  const filterActivity = ($('filter_activity').value || '').trim();
  const filterUnit = ($('filter_unit').value || '').trim();
  const filterHazard = ($('filter_hazard').value || '').trim();
  const filterSubSector = ($('filter_sub_sector').value || '').trim();
  const dateFrom = $('filter_date_from').value;
  const dateTo = $('filter_date_to').value;
  const needsSup = $('btnNeedsSup').dataset.on === '1';
  const needsMgr = $('btnNeedsMgr').dataset.on === '1';
  const completed = $('btnCompleted').dataset.on === '1';
  const needsAny = $('btnNeedsAny').dataset.on === '1';

  const rows = complaints.filter(r => {
    const est = establishments[r.establishment_unique_id] || {};
    if(q){ const searchStr = JSON.stringify(r).toLowerCase() + JSON.stringify(est).toLowerCase(); if(!searchStr.includes(q)) return false; }
    if(phone && !(r.complainant_phone || '').includes(phone)) return false;
    if(filterArea && (est.area || '') !== filterArea) return false;
    if(filterActivity){ const act = est.activity_type || est.detailed_activities || ''; if(act !== filterActivity) return false; }
    if(filterUnit){ const unit = est.unit || est.Sub_UNIT || ''; if(unit !== filterUnit) return false; }
    if(filterHazard && (est.hazard_class || '') !== filterHazard) return false;
    if(filterSubSector && String(est.Sub_Sector || '') !== filterSubSector) return false;
    const created = (r.created_at || r.received_datetime || '').split(' ')[0];
    if(dateFrom && (!created || created < dateFrom)) return false;
    if(dateTo && (!created || created > dateTo)) return false;
    if(needsSup && r.supervisor_empid) return false;
    if(needsMgr && r.manager_empid) return false;
    if(completed && !(r.closed_datetime && r.closed_datetime !== '0000-00-00 00:00:00')) return false;
    if(needsAny && (r.supervisor_empid && r.manager_empid)) return false;
    return true;
  });

  if(!rows.length){ $('tableWrap').innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</div>'; return; }

  let html = '<table><thead><tr>';
  const headers = ['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´ÙƒÙˆÙ‰','Ø§Ø³Ù… Ø§Ù„Ø´Ø§ÙƒÙŠ','Ù‡Ø§ØªÙ Ø§Ù„Ø´Ø§ÙƒÙŠ','Ø­Ø§Ù„Ø© Ø§Ù„Ø´ÙƒÙˆÙ‰','Ø§Ù„Ù…ÙØªØ´','Ø§Ù„Ø³ÙˆØ¨Ø±ÙØ§ÙŠØ²Ø±','Ø§Ù„Ù…Ø¯ÙŠØ±','Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©','Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©','ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©','ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚','Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'];
  headers.forEach(h => html += `<th>${escapeHtml(h)}</th>`);
  html += '</tr></thead><tbody>';

  rows.forEach(r => {
    const est = establishments[r.establishment_unique_id] || {};
    const dateVal = r.created_at || r.received_datetime || '';
    
    // Calculate time differences
    const responseTime = calcTimeDiff(r.received_datetime, r.inspector_received_datetime, 24);
    const closureTime = calcTimeDiff(r.inspector_received_datetime, r.closed_datetime, 72);
    
    html += '<tr>';
    html += `<td>${escapeHtml(dateVal)}</td>`;
    html += `<td>${escapeHtml(r.complainant_name || '')}</td>`;
    html += `<td>${escapeHtml(r.complainant_phone || '')}</td>`;
    html += `<td>${escapeHtml(r.complaint_status || '')}</td>`;
    html += `<td>${escapeHtml(getName(r.created_by_empid))}</td>`;
    html += `<td>${escapeHtml(getName(r.supervisor_empid))}</td>`;
    html += `<td>${escapeHtml(getName(r.manager_empid))}</td>`;
    html += `<td>${escapeHtml(est.facility_name || r.facility_name || '')}</td>`;
    html += `<td>${escapeHtml(r.license_no || est.license_no || '')}</td>`;
    html += `<td class="${responseTime.exceeded ? 'time-exceeded' : 'time-ok'}">${escapeHtml(responseTime.text)}</td>`;
    html += `<td class="${closureTime.exceeded ? 'time-exceeded' : 'time-ok'}">${escapeHtml(closureTime.text)}</td>`;
    html += `<td><button class="openBtn secondary" data-id="${r.id}">ÙØªØ­</button></td>`;
    html += '</tr>';
  });

  html += '</tbody></table>';
  $('tableWrap').innerHTML = html;
  
  document.querySelectorAll('.openBtn').forEach(b => {
    b.addEventListener('click', function(e){ e.preventDefault(); openComplaintForEdit(this.dataset.id); });
  });
}

async function openComplaintForEdit(id){
  const j = await fetchJson('complaints.php?action=get&id=' + encodeURIComponent(id));
  if(!j || !j.success){ alert('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø´ÙƒÙˆÙ‰'); return; }
  const c = j.data;
  
  $('id').value = c.id || '';
  $('establishment_unique_id').value = c.establishment_unique_id || '';
  $('license_no_display').value = c.license_no || '';
  
  const est = await getEstablishment(c.establishment_unique_id);
  $('facility_name').value = est ? (est.facility_name || '') : '';
  
  $('received_datetime').value = toLocalDateTime(c.received_datetime || c.created_at);
  $('inspector_received_datetime').value = toLocalDateTime(c.inspector_received_datetime);
  $('complainant_name').value = c.complainant_name || '';
  $('complainant_phone').value = c.complainant_phone || '';
  $('hotline_complaint_number').value = c.hotline_complaint_number || '';
  $('complaint_subject').value = c.complaint_subject || '';
  $('complainant_statement').value = c.complainant_statement || '';
  $('inspector_followup').value = c.inspector_followup || '';
  $('site_manager_statement').value = c.site_manager_statement || '';
  $('section_actions').value = c.section_actions || '';
  $('taken_actions').value = c.taken_actions || '';
  
  $('created_by_empid').value = c.created_by_empid || '';
  $('inspector_display').textContent = getName(c.created_by_empid) || '-';
  
  $('supervisor_empid').value = c.supervisor_empid || '';
  $('sup_display').textContent = getName(c.supervisor_empid) || '-';
  $('supervisor_comment').value = c.supervisor_comment || '';
  $('followup_datetime').value = toLocalDateTime(c.followup_datetime);
  
  $('manager_empid').value = c.manager_empid || '';
  $('mgr_display').textContent = getName(c.manager_empid) || '-';
  $('division_head_comment').value = c.division_head_comment || '';
  $('closed_datetime').value = toLocalDateTime(c.closed_datetime);
  
  if($('complaints_source')) $('complaints_source').value = c.complaints_source || '';
  if($('complaint_status')) $('complaint_status').value = c.complaint_status || '';
  if($('sample_status')) $('sample_status').value = c.sample_status || '';
  if($('complainant_contact_action')) $('complainant_contact_action').value = c.complainant_contact_action || '';
  if($('complaint_category')) $('complaint_category').value = c.complaint_category || '';
  if($('response_speed')) $('response_speed').value = c.response_speed || '';
  if($('food_poisoning_suspect')) $('food_poisoning_suspect').value = c.food_poisoning_suspect || '';
  
  // Calculate and display time differences
  const responseTime = calcTimeDiff(c.received_datetime, c.inspector_received_datetime, 24);
  const closureTime = calcTimeDiff(c.inspector_received_datetime, c.closed_datetime, 72);
  
  const respEl = $('response_time_display');
  respEl.textContent = responseTime.text;
  respEl.className = 'display-name ' + (responseTime.exceeded ? 'time-exceeded' : 'time-ok');
  
  const closEl = $('closure_time_display');
  closEl.textContent = closureTime.text;
  closEl.className = 'display-name ' + (closureTime.exceeded ? 'time-exceeded' : 'time-ok');
  
  $('attachment_url').value = c.attachment_url || '';
  if(c.attachment_url){
    $('attachmentLink').innerHTML = `<a href="${escapeHtml(c.attachment_url)}" target="_blank">ÙØªØ­ Ø§Ù„Ù…Ø±ÙÙ‚</a>`;
  } else {
    $('attachmentLink').innerHTML = '';
  }
  
  // Fetch and show last inspections as table
  const inspections = await fetchLastInspectionAndActions(c.establishment_unique_id);
  if(inspections && inspections.length > 0){
    let inspHtml = '<div><strong>Ø§Ù„ØªÙØªÙŠØ´Ø§Øª (Ù†ÙˆØ¹: Ø´ÙƒÙˆÙ‰)</strong></div>';
    inspHtml += '<table><thead><tr><th>Ø±Ù‚Ù… Ø§Ù„ØªÙØªÙŠØ´</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙØªØ´</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th><th>Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th></tr></thead><tbody>';
    inspections.forEach(insp => {
      inspHtml += '<tr>';
      inspHtml += `<td>${escapeHtml(insp.inspection_id || '')}</td>`;
      inspHtml += `<td>${escapeHtml(insp.inspection_date || '')}</td>`;
      inspHtml += `<td>${escapeHtml(getName(insp.inspector_user_id))}</td>`;
      inspHtml += `<td>${escapeHtml(insp.actions_concat || '-')}</td>`;
      inspHtml += `<td><a href="/shjfcs/generate_report.php?inspection_id=${insp.inspection_id}" target="_blank" class="report-link">ğŸ“„ ÙØªØ­</a></td>`;
      inspHtml += '</tr>';
    });
    inspHtml += '</tbody></table>';
    $('lastInspection').style.display = 'block';
    $('lastInspection').innerHTML = inspHtml;
    
    // If first inspection date matches complaint date, copy to inspector_received_datetime
    const firstInsp = inspections[0];
    const visitDate = firstInsp.inspection_date || '';
    const complaintDate = (c.created_at || c.received_datetime || '').split(' ')[0];
    if(visitDate && complaintDate && visitDate.split(' ')[0] === complaintDate){
      $('inspector_received_datetime').value = toLocalDateTime(visitDate);
    }
  } else {
    $('lastInspection').style.display = 'none';
    $('lastInspection').innerHTML = '';
  }
  
  await loadProductsForComplaint(c.id);
  window.scrollTo({ top: 0, behavior: 'smooth' });
  $('formMsg').textContent = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰';
}

function onResetForm(){
  $('complaintForm').reset();
  $('id').value = '';
  $('inspector_display').textContent = currentUser.EmpName || getName(currentUser.EmpID) || '-';
  $('sup_display').textContent = '-';
  $('mgr_display').textContent = '-';
  $('response_time_display').textContent = '-';
  $('response_time_display').className = 'display-name';
  $('closure_time_display').textContent = '-';
  $('closure_time_display').className = 'display-name';
  $('lastInspection').style.display = 'none';
  $('lastInspection').innerHTML = '';
  $('estDetails').innerHTML = '';
  $('attachmentLink').innerHTML = '';
  $('productsList').innerHTML = '';
  addProductRow(false);
  $('formMsg').textContent = '';
}

async function onSaveComplaint(){
  const id = $('id').value;
  const payload = {};
  const fields = ['establishment_unique_id','received_datetime','complaints_source','hotline_complaint_number','complainant_name','complainant_phone','complainant_statement','complaint_subject','inspector_followup','site_manager_statement','sample_status','complainant_contact_action','inspector_received_datetime','supervisor_comment','followup_datetime','division_head_comment','closed_datetime','complaint_status','complaint_category','response_speed','section_actions','food_poisoning_suspect','taken_actions'];
  fields.forEach(k => {
    const el = $(k); if(!el) return;
    let v = el.value || '';
    if(el.type === 'datetime-local' && v) v = toDBDateTimeFromLocal(v);
    payload[k] = v;
  });
  payload.supervisor_empid = $('supervisor_empid').value || '';
  payload.manager_empid = $('manager_empid').value || '';
  if(!id) payload.created_by_empid = currentUser.EmpID || '';
  
  const params = new URLSearchParams({ action: id ? 'update' : 'create', ...(id ? { id } : {}), ...payload });
  try {
    const res = await fetch('complaints.php', { method:'POST', body: params, credentials:'same-origin' });
    const j = await res.json();
    if(!j.success){ alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (j.message || '')); return; }
    if(!id) $('id').value = j.id;
    $('formMsg').textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸';
    await loadComplaints();
    await preloadEstablishments();
    populateFilters();
    renderTable();
  } catch(e){ console.error(e); alert('Ø®Ø·Ø£ Ø§Ù„Ø­ÙØ¸'); }
}

async function onSupervisorSign(){
  const id = $('id').value;
  if(!id){ alert('Ø§ÙØªØ­ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  
  // Check permission - only admin or super admin can sign as supervisor
  const perms = currentUser.permissions || {};
  if(!perms.isAdmin && !perms.isSuperAdmin){
    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø³ÙˆØ¨Ø±ÙØ§ÙŠØ²Ø±');
    return;
  }
  
  const ud = await fetchJson('user_data.php');
  if(!ud || !ud.success || !ud.user_data || !ud.user_data.EmpID){ alert('ØºÙŠØ± Ù…Ø³Ø¬Ù„'); return; }
  const emp = ud.user_data.EmpID;
  const followup = formatDateInTimeZone(new Date(), 'Asia/Dubai');
  const params = new URLSearchParams({ 
    action: 'update', 
    id, 
    supervisor_empid: emp, 
    supervisor_comment: $('supervisor_comment').value || '',
    complaint_category: $('complaint_category').value || '',
    response_speed: $('response_speed').value || '',
    followup_datetime: followup 
  });
  try {
    const res = await fetch('complaints.php', { method:'POST', body: params, credentials:'same-origin' });
    const j = await res.json();
    if(!j.success){ alert('ÙØ´Ù„ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø³ÙˆØ¨Ø±ÙØ§ÙŠØ²Ø±'); return; }
    $('supervisor_empid').value = emp;
    $('sup_display').textContent = getName(emp);
    $('followup_datetime').value = toLocalDateTime(followup);
    await loadComplaints(); renderTable();
  } catch(e){ console.error(e); alert('Ø®Ø·Ø£'); }
}

async function onSupervisorClear(){
  const id = $('id').value;
  if(!id){ alert('Ø§ÙØªØ­ Ø§Ù„Ø´ÙƒÙˆÙ‰'); return; }
  if(!confirm('Ø­Ø°Ù ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø³ÙˆØ¨Ø±ÙØ§ÙŠØ²Ø±ØŸ')) return;
  const params = new URLSearchParams({ action: 'update', id, supervisor_empid: '', supervisor_comment: '', followup_datetime: '' });
  try {
    const res = await fetch('complaints.php', { method:'POST', body: params, credentials:'same-origin' });
    const j = await res.json();
    if(!j.success){ alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù'); return; }
    $('supervisor_empid').value = '';
    $('sup_display').textContent = '-';
    $('followup_datetime').value = '';
    await loadComplaints(); renderTable();
  } catch(e){ console.error(e); alert('Ø®Ø·Ø£'); }
}

async function onManagerSign(){
  const id = $('id').value;
  if(!id){ alert('Ø§ÙØªØ­ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  
  // Check permission - only super admin can sign as manager
  const perms = currentUser.permissions || {};
  if(!perms.isSuperAdmin){
    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ± - ÙŠØªØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ø³ÙˆØ¨Ø± Ø£Ø¯Ù…Ù†');
    return;
  }
  
  const ud = await fetchJson('user_data.php');
  if(!ud || !ud.success || !ud.user_data || !ud.user_data.EmpID){ alert('ØºÙŠØ± Ù…Ø³Ø¬Ù„'); return; }
  const emp = ud.user_data.EmpID;
  const closed = formatDateInTimeZone(new Date(), 'Asia/Dubai');
  const params = new URLSearchParams({ action: 'update', id, manager_empid: emp, division_head_comment: $('division_head_comment').value || '', complaint_status: $('complaint_status').value || '', closed_datetime: closed });
  try {
    const res = await fetch('complaints.php', { method:'POST', body: params, credentials:'same-origin' });
    const j = await res.json();
    if(!j.success){ alert('ÙØ´Ù„ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±'); return; }
    $('manager_empid').value = emp;
    $('mgr_display').textContent = getName(emp);
    $('closed_datetime').value = toLocalDateTime(closed);
    await loadComplaints(); renderTable();
  } catch(e){ console.error(e); alert('Ø®Ø·Ø£'); }
}

async function onManagerClear(){
  const id = $('id').value;
  if(!id){ alert('Ø§ÙØªØ­ Ø§Ù„Ø´ÙƒÙˆÙ‰'); return; }
  
  // Check permission - only super admin can clear manager signature
  const perms = currentUser.permissions || {};
  if(!perms.isSuperAdmin){
    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±');
    return;
  }
  
  if(!confirm('Ø­Ø°Ù ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠØ±ØŸ')) return;
  const params = new URLSearchParams({ action: 'update', id, manager_empid: '', division_head_comment: '', complaint_status: '', closed_datetime: '' });
  try {
    const res = await fetch('complaints.php', { method:'POST', body: params, credentials:'same-origin' });
    const j = await res.json();
    if(!j.success){ alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù'); return; }
    $('manager_empid').value = '';
    $('mgr_display').textContent = '-';
    $('closed_datetime').value = '';
    await loadComplaints(); renderTable();
  } catch(e){ console.error(e); alert('Ø®Ø·Ø£'); }
}

async function onUploadAttachment(){
  const fileInput = $('attachment_file');
  const f = fileInput && fileInput.files[0];
  if(!f){ alert('Ø§Ø®ØªØ± Ù…Ù„Ù'); return; }
  const fd = new FormData();
  fd.append('file', f);
  try {
    const res = await fetch('complaints.php?action=upload', { method:'POST', body: fd, credentials:'same-origin' });
    const j = await res.json();
    if(!j.success){ alert('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹'); return; }
    $('attachment_url').value = j.path || j.filename || '';
    $('attachmentLink').innerHTML = `<a href="${escapeHtml($('attachment_url').value)}" target="_blank">ÙØªØ­ Ø§Ù„Ù…Ø±ÙÙ‚</a>`;
  } catch(e){ console.error(e); alert('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø±ÙØ¹'); }
}

async function onSearchLicense(){
  const license = $('license_no_search').value.trim();
  if(!license){ $('estList').textContent = 'Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ'; return; }
  $('estList').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
  let results = [];
  const r1 = await fetchJson('get_establishments_by_license.php?license_no=' + encodeURIComponent(license));
  if(r1 && r1.success && Array.isArray(r1.data)) results = r1.data;
  if(!results.length){
    const r2 = await fetchJson('complaints.php?action=establishments&license_no=' + encodeURIComponent(license));
    if(r2 && r2.success && Array.isArray(r2.data)) results = r2.data;
  }
  if(!results.length){ $('estList').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´Ø¢Øª'; return; }
  $('estList').innerHTML = '';
  results.forEach(item => {
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'secondary';
    b.style.margin = '4px';
    b.textContent = (item.facility_name || item.unique_id) + ' â€” ' + (item.unique_id || '');
    b.addEventListener('click', async function(){
      $('establishment_unique_id').value = item.unique_id || '';
      $('license_no_display').value = item.license_no || license;
      $('facility_name').value = item.facility_name || '';
      Array.from($('estList').querySelectorAll('button')).forEach(x => x.disabled = false);
      this.disabled = true;
      const est = await getEstablishment(item.unique_id);
      if(est){
        $('estDetails').innerHTML = `
          <div><strong>Ø§Ù„Ù…Ù†Ø´Ø£Ø©:</strong> ${escapeHtml(est.facility_name || '-')}</div>
          <div><strong>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${escapeHtml(est.area || '-')}</div>
          <div><strong>Ø§Ù„Ù†Ø´Ø§Ø·:</strong> ${escapeHtml(est.activity_type || est.detailed_activities || '-')}</div>
          <div><strong>Ø§Ù„ÙˆØ­Ø¯Ø©:</strong> ${escapeHtml(est.unit || est.Sub_UNIT || '-')}</div>
          <div><strong>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©:</strong> ${escapeHtml(est.hazard_class || '-')}</div>
          <div><strong>Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong> ${escapeHtml(String(est.Sub_Sector || '-'))}</div>`;
      }
      const inspections = await fetchLastInspectionAndActions(item.unique_id);
      if(inspections && inspections.length > 0){
        let inspHtml = '<div><strong>Ø§Ù„ØªÙØªÙŠØ´Ø§Øª (Ù†ÙˆØ¹: Ø´ÙƒÙˆÙ‰)</strong></div>';
        inspHtml += '<table><thead><tr><th>Ø±Ù‚Ù… Ø§Ù„ØªÙØªÙŠØ´</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙØªØ´</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th><th>Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th></tr></thead><tbody>';
        inspections.forEach(insp => {
          inspHtml += '<tr>';
          inspHtml += `<td>${escapeHtml(insp.inspection_id || '')}</td>`;
          inspHtml += `<td>${escapeHtml(insp.inspection_date || '')}</td>`;
          inspHtml += `<td>${escapeHtml(getName(insp.inspector_user_id))}</td>`;
          inspHtml += `<td>${escapeHtml(insp.actions_concat || '-')}</td>`;
          inspHtml += `<td><a href="/shjfcs/generate_report.php?inspection_id=${insp.inspection_id}" target="_blank" class="report-link">ğŸ“„ ÙØªØ­</a></td>`;
          inspHtml += '</tr>';
        });
        inspHtml += '</tbody></table>';
        $('lastInspection').style.display = 'block';
        $('lastInspection').innerHTML = inspHtml;
      } else {
        $('lastInspection').style.display = 'none';
      }
    });
    $('estList').appendChild(b);
  });
}

// Products with full schema
function addProductRow(focus=false){
  const tpl = document.createElement('div');
  tpl.className = 'product-row';
  tpl.innerHTML = `
    <div class="row">
      <div class="col"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input name="product_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"></div>
      <div class="col"><label>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</label><input name="brand_name" placeholder="Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©"></div>
      <div class="col"><label>Ù†ÙˆØ¹ Ø§Ù„Ø¹ÙŠÙ†Ø©</label><input name="sample_type" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø¹ÙŠÙ†Ø©"></div>
      <div class="col"><label>Ø¨Ù„Ø¯ Ø§Ù„Ù…Ù†Ø´Ø£</label><input name="country_of_origin" placeholder="Ø¨Ù„Ø¯ Ø§Ù„Ù…Ù†Ø´Ø£"></div>
    </div>
    <div class="row" style="margin-top:4px">
      <div class="col"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†ØªØ§Ø¬</label><input name="production_date" type="date"></div>
      <div class="col"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input name="expiry_date" type="date"></div>
      <div class="col"><label>Ø§Ù„ÙˆØ²Ù†</label><input name="weight" placeholder="Ø§Ù„ÙˆØ²Ù†"></div>
      <div class="col"><label>Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©</label><input name="batch_number" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©"></div>
    </div>
    <div class="row" style="margin-top:4px">
      <div class="col"><label>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø±</label><textarea name="lab_result" placeholder="Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø®ØªØ¨Ø±"></textarea></div>
      <div class="col"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea name="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea></div>
    </div>
    <div style="margin-top:4px">
      <button class="saveProduct secondary" type="button">Ø­ÙØ¸</button>
      <button class="removeProduct clear" type="button">Ø­Ø°Ù</button>
    </div>`;
  
  const saveBtn = tpl.querySelector('.saveProduct');
  const removeBtn = tpl.querySelector('.removeProduct');
  
  saveBtn.addEventListener('click', async function(){
    const cid = $('id').value;
    if(!cid){ alert('Ø§Ø­ÙØ¸ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹'); return; }
    const fd = new FormData();
    fd.append('action', 'products_create');
    fd.append('complaint_id', cid);
    ['product_name','brand_name','sample_type','country_of_origin','production_date','expiry_date','weight','batch_number','lab_result','notes'].forEach(k => {
      const el = tpl.querySelector(`[name="${k}"]`);
      fd.append(k, el ? el.value : '');
    });
    this.disabled = true;
    this.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';
    try {
      const res = await fetch('complaints.php', { method:'POST', body: fd, credentials:'same-origin' });
      const j = await res.json();
      if(!j.success){ alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬'); this.disabled = false; this.textContent = 'Ø­ÙØ¸'; return; }
      tpl.setAttribute('data-id', j.id);
      this.textContent = 'Ù…Ø­ÙÙˆØ¸';
      this.disabled = true;
    } catch(e){ console.error(e); alert('Ø®Ø·Ø£'); this.disabled = false; this.textContent = 'Ø­ÙØ¸'; }
  });
  
  removeBtn.addEventListener('click', async function(){
    const pid = tpl.getAttribute('data-id');
    if(pid){
      if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
      const fd = new FormData();
      fd.append('action', 'products_delete');
      fd.append('id', pid);
      try {
        const res = await fetch('complaints.php', { method:'POST', body: fd, credentials:'same-origin' });
        const j = await res.json();
        if(!j.success){ alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù'); return; }
      } catch(e){ console.error(e); alert('Ø®Ø·Ø£ Ø§Ù„Ø­Ø°Ù'); return; }
    }
    tpl.remove();
  });
  
  $('productsList').appendChild(tpl);
  if(focus){ const f = tpl.querySelector('[name="product_name"]'); if(f) f.focus(); }
}

async function loadProductsForComplaint(cid){
  $('productsList').innerHTML = '';
  if(!cid){ addProductRow(false); return; }
  const j = await fetchJson('complaints.php?action=products_list&complaint_id=' + encodeURIComponent(cid));
  if(!j || !j.success || !j.data || !j.data.length){ addProductRow(false); return; }
  j.data.forEach(p => {
    addProductRow(false);
    const row = $('productsList').lastElementChild;
    if(p.id) row.setAttribute('data-id', p.id);
    ['product_name','brand_name','sample_type','country_of_origin','production_date','expiry_date','weight','batch_number','lab_result','notes'].forEach(k => {
      const el = row.querySelector(`[name="${k}"]`);
      if(el && p[k] != null) el.value = p[k];
    });
    const saveBtn = row.querySelector('.saveProduct');
    saveBtn.textContent = 'Ù…Ø­ÙÙˆØ¸';
    saveBtn.disabled = true;
  });
}

async function saveProductsBulk(){
  const cid = $('id').value;
  if(!cid){ alert('Ø§Ø­ÙØ¸ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const products = [];
  document.querySelectorAll('#productsList .product-row').forEach(row => {
    const obj = {};
    ['product_name','brand_name','sample_type','country_of_origin','production_date','expiry_date','weight','batch_number','lab_result','notes'].forEach(k => {
      const el = row.querySelector(`[name="${k}"]`);
      obj[k] = el ? el.value.trim() : '';
    });
    if(obj.product_name) products.push(obj);
  });
  if(!products.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª'); return; }
  try {
    const res = await fetch('complaint_products.php?action=bulk_create', {
      method: 'POST', credentials: 'same-origin',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ complaint_id: Number(cid), products })
    });
    const j = await res.json();
    if(!j.success){ alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª'); return; }
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
    await loadProductsForComplaint(cid);
  } catch(e){ console.error(e); alert('Ø®Ø·Ø£'); }
}

function bindUI(){
  $('btnSearchLicense').addEventListener('click', onSearchLicense);
  $('btnClearLicense').addEventListener('click', function(){
    $('license_no_search').value = '';
    $('estList').innerHTML = '';
    $('estDetails').innerHTML = '';
  });
  $('btnApplyFilters').addEventListener('click', renderTable);
  $('btnResetFilters').addEventListener('click', function(){
    ['searchAll','filter_phone','filter_date_from','filter_date_to'].forEach(id => { if($(id)) $(id).value = ''; });
    ['filter_area','filter_activity','filter_unit','filter_hazard','filter_sub_sector'].forEach(id => { if($(id)) $(id).value = ''; });
    renderTable();
  });
  ['btnNeedsSup','btnNeedsMgr','btnCompleted','btnNeedsAny'].forEach(id => {
    const b = $(id);
    if(b){
      b.addEventListener('click', function(){
        this.dataset.on = this.dataset.on === '1' ? '0' : '1';
        this.style.background = this.dataset.on === '1' ? 'var(--accent)' : '';
        this.style.color = this.dataset.on === '1' ? '#fff' : '';
        renderTable();
      });
    }
  });
  $('btnReload').addEventListener('click', async function(){
    await loadComplaints();
    await preloadEstablishments();
    await preloadLastInspections();
    populateFilters();
    renderTable();
  });
  $('btnNewComplaint').addEventListener('click', function(){
    onResetForm();
    window.scrollTo({ top: $('formCard').offsetTop - 20, behavior: 'smooth' });
    $('formMsg').textContent = 'Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø© - Ù‚Ù… Ø¨Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø£ÙˆÙ„Ø§Ù‹';
  });
  $('btnSave').addEventListener('click', onSaveComplaint);
  $('btnReset').addEventListener('click', onResetForm);
  $('btnSaveSupervisor').addEventListener('click', onSupervisorSign);
  $('btnSupervisorClear').addEventListener('click', onSupervisorClear);
  $('btnSaveManager').addEventListener('click', onManagerSign);
  $('btnManagerClear').addEventListener('click', onManagerClear);
  $('btnAddProduct').addEventListener('click', function(){ addProductRow(true); });
  $('btnSaveProducts').addEventListener('click', saveProductsBulk);
  $('btnUpload').addEventListener('click', onUploadAttachment);
  
  // Auto-compute response_speed when complaint_category changes
  if($('complaint_category')) {
    $('complaint_category').addEventListener('change', function(){
      const speed = complaintUrgency(this.value);
      if($('response_speed')) $('response_speed').value = speed;
    });
  }
  
  // Auto-compute complaint_status when section_actions changes
  if($('section_actions')) {
    $('section_actions').addEventListener('change', function(){
      const status = derivedComplaintStatus(this.value);
      if($('complaint_status') && status) $('complaint_status').value = status;
    });
  }
}

async function init(){
  populateSelect('complaints_source', complaintSources, true, '-- Ø§Ø®ØªØ± --');
  populateSelect('sample_status', sampleStatusOptions, true, '-- Ø§Ø®ØªØ± --');
  populateSelect('complainant_contact_action', complainantContactActions, true, '-- Ø§Ø®ØªØ± --');
  populateSelect('complaint_status', complaintStatusOptions, true, '-- Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© --');
  populateSelect('complaint_category', complaintCategories, true, '-- Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ --');
  populateSelect('food_poisoning_suspect', foodPoisoningSuspects, true, '-- Ø§Ø®ØªØ± --');
  populateSelect('section_actions', sectionActionsOptions, true, '-- Ø§Ø®ØªØ± Ø¥Ø¬Ø±Ø§Ø¡ --');
  bindUI();
  await loadUserAndEmployees();
  await loadComplaints();
  await preloadEstablishments();
  await preloadLastInspections();
  populateFilters();
  renderTable();
  addProductRow(false);
}

init();

})();
</script>
<script src="complaintResponse.js"></script>
</body>
</html>
